@page "/student/classoffering/{Id:int}/grades"
@rendermode InteractiveServer

@using System.Security.Claims
@using GradeProgressMonitoring.Data
@using GradeProgressMonitoring.Models
@using GradeProgressMonitoring.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms

@attribute [Authorize(Roles = "Student")]

@inject ApplicationDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<h3>My Grades</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (offering is null)
{
    <p class="text-danger">Class offering not found.</p>
}
else if (!isEnrolled)
{
    <p class="text-danger">You are not enrolled in this class offering.</p>
}
else
{
    <div style="margin-bottom:12px;">
        <p style="margin:0;"><b>@offering.SubjectCode</b> — @offering.SubjectTitle</p>
        <p style="margin:0;">
            @displaySection • @offering.Term / @offering.SchoolYear • <b>@offering.ClassType</b>
        </p>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:10px;">
        <button class="btn btn-outline-secondary" type="button" @onclick="Back">Back</button>

        <label style="display:flex; gap:8px; align-items:center; margin:0;">
            <input type="checkbox" @bind="whatIfEnabled" @bind:after="RecomputeTotals" />
            Enable What-If
        </label>

        <button class="btn btn-sm btn-outline-danger"
                type="button"
                @onclick="ResetWhatIf"
                @attributes="ResetWhatIfButtonAttributes">
            Reset What-If
        </button>
    </div>

    <div style="display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start;">
        <div>
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Component</th>
                        <th>Item</th>
                        <th style="width:130px;">Score</th>
                        <th style="width:130px;">Out of</th>
                        <th style="width:180px;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var r in rows)
                    {
                        <tr>
                            <td>@r.ComponentName</td>
                            <td>@r.ItemLabel</td>
                            <td>
                                @if (!r.HasActualScore && whatIfEnabled)
                                {
                                    <InputNumber TValue="decimal?"
                                                 class="form-control form-control-sm"
                                                 @bind-Value="r.WhatIfScore"
                                                 @bind-Value:after="RecomputeTotals"
                                                 @attributes="GetWhatIfInputAttributes(r)" />
                                    <small class="text-muted">What-If</small>
                                }
                                else
                                {
                                    <span>@(r.ActualScore?.ToString() ?? "—")</span>
                                }
                            </td>
                            <td>@r.MaxScore</td>
                            <td>
                                @if (r.HasActualScore)
                                {
                                    <span class="text-success">Graded</span>
                                }
                                else
                                {
                                    <span class="text-muted">Not graded yet</span>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            @if (rows.Count == 0)
            {
                <p class="text-muted">No items found.</p>
            }
        </div>

        <div class="card">
            <div class="card-body">
                <h5 style="margin-top:0;">Summary</h5>

                <div style="display:flex; justify-content:space-between;">
                    <span>Total earned (graded/what-if items)</span>
                    <b>@earned.ToString("0.##")</b>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    <span>Total possible (graded/what-if items)</span>
                    <b>@possible.ToString("0.##")</b>
                </div>

                <hr />

                <div style="display:flex; justify-content:space-between;">
                    <span>Weighted standing</span>
                    <b>@totalPercent.ToString("0.##")%</b>
                </div>

                <div style="display:flex; justify-content:space-between;">
                    <span>Grade equivalent</span>
                    <b>@gradeEquivalent</b>
                </div>

                <p class="text-muted" style="margin:10px 0 0 0; font-size:0.85rem;">
                    Grades reflect <b>current standing</b>. Ungraded components are treated as <b>0</b> until completed
                    (e.g., if Major Exam is not yet taken, your standing can appear failing).
                </p>

                @if (whatIfEnabled)
                {
                    <div style="margin-top:10px;">
                        <span class="badge bg-info text-dark">What-If active</span>
                        <p class="text-muted" style="margin:8px 0 0 0;">
                            What-If scores are not saved. They only simulate your grade.
                        </p>
                    </div>
                }

                <hr />

                <h6>Component Breakdown (Weighted)</h6>
                <table class="table table-sm" style="margin-bottom:0;">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th style="width:80px;">Weight</th>
                            <th style="width:110px;">Current %</th>
                            <th style="width:110px;">Contribution</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var c in componentSummaries.OrderBy(x => x.OrderNo))
                        {
                            <tr>
                                <td>@c.Name</td>
                                <td>@c.WeightPercent.ToString("0.##")%</td>
                                <td>
                                    @if (c.CurrentPercent is null)
                                    {
                                        <span class="text-muted">—</span>
                                    }
                                    else
                                    {
                                        <span>@c.CurrentPercent.Value.ToString("0.##")%</span>
                                    }
                                </td>
                                <td>
                                    <span>@c.Contribution.ToString("0.##")</span>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

            </div>
        </div>
    </div>
}

@code {
    [Parameter] public int Id { get; set; }

    private bool loading = true;
    private bool isEnrolled = false;
    private bool whatIfEnabled = false;

    private ClassOffering? offering;
    private Enrollment? myEnrollment;
    private string displaySection = "TBD";

    // For display totals (only graded/what-if items)
    private decimal earned = 0m;
    private decimal possible = 0m;

    // Conservative weighted standing (missing components treated as 0)
    private decimal totalPercent = 0m;
    private string gradeEquivalent = "—";

    private readonly List<GradeRow> rows = new();
    private List<ComponentSummary> componentSummaries = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
        RecomputeTotals();
    }

    private async Task LoadAsync()
    {
        loading = true;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        var userId = user.FindFirstValue(ClaimTypes.NameIdentifier);

        offering = await Db.ClassOfferings
            .AsNoTracking()
            .FirstOrDefaultAsync(x => x.ClassOfferingId == Id);

        if (offering is null)
        {
            loading = false;
            return;
        }

        myEnrollment = await Db.Enrollments
            .AsNoTracking()
            .FirstOrDefaultAsync(e => e.ClassOfferingId == Id && e.StudentUserId == userId);

        isEnrolled = myEnrollment is not null;

        if (!isEnrolled)
        {
            loading = false;
            return;
        }

        displaySection = string.IsNullOrWhiteSpace(myEnrollment?.Section)
            ? offering.CourseYearSection
            : myEnrollment!.Section!;

        var components = await Db.GradingComponents
            .AsNoTracking()
            .Where(c => c.ClassOfferingId == Id && c.IsEnabled)
            .OrderBy(c => c.ComponentType)
            .ToListAsync();

        var compIds = components.Select(c => c.GradingComponentId).ToList();

        var items = await Db.ComponentItems
            .AsNoTracking()
            .Where(i => compIds.Contains(i.GradingComponentId))
            .OrderBy(i => i.GradingComponentId)
            .ThenBy(i => i.OrderNo)
            .ToListAsync();

        var itemIds = items.Select(i => i.ComponentItemId).ToList();

        var scores = await Db.ScoreEntries
            .AsNoTracking()
            .Where(s => s.StudentUserId == userId && itemIds.Contains(s.ComponentItemId))
            .ToListAsync();

        rows.Clear();

        foreach (var item in items)
        {
            var comp = components.First(c => c.GradingComponentId == item.GradingComponentId);
            var entry = scores.FirstOrDefault(s => s.ComponentItemId == item.ComponentItemId);

            rows.Add(new GradeRow
            {
                GradingComponentId = comp.GradingComponentId,
                ComponentType = comp.ComponentType,
                ComponentOrder = (int)comp.ComponentType, // stable-ish ordering; can refine if needed
                ComponentName = GetComponentDisplayName(comp.ComponentType),
                ComponentWeightPercent = comp.WeightPercent,

                ItemLabel = item.Label,
                MaxScore = item.MaxScore,

                ActualScore = entry?.Score,
                WhatIfScore = null
            });
        }

        loading = false;
    }

    private string GetComponentDisplayName(ComponentType t)
    {
        if (offering is null) return t.ToString();
        return GradingTemplateService.GetComponentDisplayName(t, offering.ClassType);
    }

    /// <summary>
    /// Conservative policy:
    /// - Overall standing is weighted over 100% always (no renormalization).
    /// - Missing/ungraded components contribute 0.
    /// - Quizzes apply "Consideration Quiz replaces the lowest" per period (Prelim/Midterm/Finals).
    /// </summary>
    private void RecomputeTotals()
    {
        // totals for display (only graded/what-if items)
        decimal e = 0m;
        decimal p = 0m;

        componentSummaries = new List<ComponentSummary>();

        // overall weighted standing (0..100)
        decimal weightedStandingTotal = 0m;

        // group per component
        var groups = rows.GroupBy(r => new
        {
            r.GradingComponentId,
            r.ComponentType,
            r.ComponentName,
            r.ComponentWeightPercent,
            r.ComponentOrder
        });

        foreach (var g in groups)
        {
            decimal? compPercent;

            // Special handling for Quizzes: consideration replaces lowest per period
            if (g.Key.ComponentType == ComponentType.Quizzes)
            {
                var quizResult = ComputeQuizzesPercentWithReplacement(g.ToList(), whatIfEnabled);

                compPercent = quizResult.Percent;

                // display totals: only include items that have a score (actual/what-if) in the chosen effective set
                foreach (var chosen in quizResult.ChosenRows)
                {
                    var sc = GetEffectiveScore(chosen, whatIfEnabled);
                    if (!sc.HasValue) continue;

                    e += Clamp(sc.Value, 0, chosen.MaxScore);
                    p += chosen.MaxScore;
                }
            }
            else
            {
                // Normal components:
                // - Comp percent uses scored items only (so it can show progress),
                //   BUT overall standing still treats missing components as 0 because we don't renormalize.
                decimal compEarned = 0m;
                decimal compPossible = 0m;

                foreach (var r in g)
                {
                    var sc = GetEffectiveScore(r, whatIfEnabled);
                    if (!sc.HasValue) continue;

                    compEarned += Clamp(sc.Value, 0, r.MaxScore);
                    compPossible += r.MaxScore;

                    e += Clamp(sc.Value, 0, r.MaxScore);
                    p += r.MaxScore;
                }

                compPercent = (compPossible <= 0m) ? (decimal?)null : (compEarned / compPossible) * 100m;
            }

            // Contribution: missing/ungraded -> 0
            var contribution = (compPercent.HasValue)
                ? compPercent.Value * (g.Key.ComponentWeightPercent / 100m)
                : 0m;

            weightedStandingTotal += contribution;

            componentSummaries.Add(new ComponentSummary
            {
                OrderNo = g.Key.ComponentOrder,
                Name = g.Key.ComponentName,
                WeightPercent = g.Key.ComponentWeightPercent,
                CurrentPercent = compPercent,
                Contribution = contribution
            });
        }

        earned = e;
        possible = p;

        // ✅ Conservative standing: no renormalization
        totalPercent = weightedStandingTotal;

        gradeEquivalent = ToGradeEquivalent(totalPercent);

        StateHasChanged();
    }

    // -----------------------
    // Quizzes: replacement rule
    // -----------------------
    private enum QuizPeriod { Prelim, Midterm, Finals, Unknown }
    private enum QuizKind { Short, Long, Consideration, Other }

    private static QuizPeriod GetQuizPeriod(string label)
    {
        if (label.StartsWith("Prelim", StringComparison.OrdinalIgnoreCase)) return QuizPeriod.Prelim;
        if (label.StartsWith("Midterm", StringComparison.OrdinalIgnoreCase)) return QuizPeriod.Midterm;
        if (label.StartsWith("Finals", StringComparison.OrdinalIgnoreCase)) return QuizPeriod.Finals;
        return QuizPeriod.Unknown;
    }

    private static QuizKind GetQuizKind(string label)
    {
        if (label.Contains("Short Quiz", StringComparison.OrdinalIgnoreCase)) return QuizKind.Short;
        if (label.Contains("Long Quiz", StringComparison.OrdinalIgnoreCase)) return QuizKind.Long;
        if (label.Contains("Consideration Quiz", StringComparison.OrdinalIgnoreCase)) return QuizKind.Consideration;
        return QuizKind.Other;
    }

    private static decimal? GetEffectiveScore(GradeRow r, bool whatIfEnabled)
    {
        if (r.ActualScore.HasValue) return r.ActualScore;
        if (whatIfEnabled && r.WhatIfScore.HasValue) return r.WhatIfScore;
        return null;
    }

    private sealed class QuizComputeResult
    {
        public decimal? Percent { get; set; }
        public List<GradeRow> ChosenRows { get; set; } = new();
    }

    /// <summary>
    /// Computes quiz percent (0..100) with consideration replacement:
    /// For each period, base is Short + Long. Consideration may replace the lower of those two.
    /// Conservative handling:
    /// - If only one of Short/Long has a score so far, we compute percent using only what is scored (progress view).
    /// - If neither has a score and only consideration has a score, we show percent based on that one (progress view).
    /// This percent affects contribution; ungraded quiz component still contributes 0 overall.
    /// </summary>
    private static QuizComputeResult ComputeQuizzesPercentWithReplacement(
        List<GradeRow> quizRows,
        bool whatIfEnabled)
    {
        decimal earned = 0m;
        decimal possible = 0m;

        var chosen = new List<GradeRow>();

        foreach (var pg in quizRows.GroupBy(r => GetQuizPeriod(r.ItemLabel)))
        {
            if (pg.Key == QuizPeriod.Unknown) continue;

            var shortRow = pg.FirstOrDefault(r => GetQuizKind(r.ItemLabel) == QuizKind.Short);
            var longRow = pg.FirstOrDefault(r => GetQuizKind(r.ItemLabel) == QuizKind.Long);
            var consRow = pg.FirstOrDefault(r => GetQuizKind(r.ItemLabel) == QuizKind.Consideration);

            // gather scored base candidates
            var baseList = new List<(GradeRow row, decimal pct)>();

            if (shortRow is not null)
            {
                var s = GetEffectiveScore(shortRow, whatIfEnabled);
                if (s.HasValue && shortRow.MaxScore > 0m)
                    baseList.Add((shortRow, s.Value / shortRow.MaxScore));
            }

            if (longRow is not null)
            {
                var l = GetEffectiveScore(longRow, whatIfEnabled);
                if (l.HasValue && longRow.MaxScore > 0m)
                    baseList.Add((longRow, l.Value / longRow.MaxScore));
            }

            decimal? consPct = null;
            if (consRow is not null)
            {
                var c = GetEffectiveScore(consRow, whatIfEnabled);
                if (c.HasValue && consRow.MaxScore > 0m)
                    consPct = c.Value / consRow.MaxScore;
            }

            // If no scores at all this period, skip it
            if (baseList.Count == 0 && consPct is null) continue;

            // If we have 2 base scores (short+long), allow consideration to replace the lower
            if (baseList.Count >= 2 && consPct.HasValue)
            {
                var idxLow = baseList[0].pct <= baseList[1].pct ? 0 : 1;
                if (consPct.Value > baseList[idxLow].pct)
                {
                    // replace the lower quiz's pct, keeping that quiz's MaxScore
                    baseList[idxLow] = (baseList[idxLow].row, consPct.Value);
                }
            }
            else if (baseList.Count == 1 && consPct.HasValue && consRow is not null)
            {
                // progress: let consideration act as an additional improvement signal
                // (it won't create extra "3 quizzes"; it's only for progress view)
                baseList.Add((consRow, consPct.Value));
            }
            else if (baseList.Count == 0 && consPct.HasValue && consRow is not null)
            {
                baseList.Add((consRow, consPct.Value));
            }

            // accumulate chosen rows (for display totals)
            foreach (var (row, pct) in baseList)
            {
                chosen.Add(row);
                earned += pct * row.MaxScore;
                possible += row.MaxScore;
            }
        }

        var percent = possible <= 0m ? (decimal?)null : (earned / possible) * 100m;

        return new QuizComputeResult
        {
            Percent = percent,
            ChosenRows = chosen
        };
    }

    // -----------------------
    // Utilities + UI helpers
    // -----------------------
    private static decimal Clamp(decimal v, decimal min, decimal max)
        => (v < min) ? min : (v > max) ? max : v;

    private static string ToGradeEquivalent(decimal percent)
    {
        if (percent >= 96) return "1.00";
        if (percent >= 93) return "1.25";
        if (percent >= 90) return "1.50";
        if (percent >= 87) return "1.75";
        if (percent >= 84) return "2.00";
        if (percent >= 81) return "2.25";
        if (percent >= 78) return "2.50";
        if (percent >= 75) return "3.00";
        return "5.00";
    }

    private void ResetWhatIf()
    {
        foreach (var r in rows) r.WhatIfScore = null;
        RecomputeTotals();
    }

    private void Back() => Nav.NavigateTo("/student/subjects");

    private Dictionary<string, object> ResetWhatIfButtonAttributes
    {
        get
        {
            var attrs = new Dictionary<string, object>();
            if (!whatIfEnabled)
                attrs["disabled"] = "disabled";
            return attrs;
        }
    }

    private Dictionary<string, object> GetWhatIfInputAttributes(GradeRow r)
    {
        var attrs = new Dictionary<string, object>();

        if (!whatIfEnabled || r.HasActualScore)
        {
            attrs["disabled"] = "disabled";
            return attrs;
        }

        attrs["min"] = "0";
        attrs["max"] = r.MaxScore.ToString("0.##");

        return attrs;
    }

    private sealed class GradeRow
    {
        public int GradingComponentId { get; set; }
        public ComponentType ComponentType { get; set; }
        public int ComponentOrder { get; set; }

        public string ComponentName { get; set; } = "";
        public decimal ComponentWeightPercent { get; set; }

        public string ItemLabel { get; set; } = "";
        public decimal MaxScore { get; set; }

        public decimal? ActualScore { get; set; }
        public decimal? WhatIfScore { get; set; }

        public bool HasActualScore => ActualScore.HasValue;
    }

    private sealed class ComponentSummary
    {
        public int OrderNo { get; set; }
        public string Name { get; set; } = "";
        public decimal WeightPercent { get; set; }
        public decimal? CurrentPercent { get; set; }  // null = no scores yet
        public decimal Contribution { get; set; }     // weight * percent, or 0 if null
    }
}