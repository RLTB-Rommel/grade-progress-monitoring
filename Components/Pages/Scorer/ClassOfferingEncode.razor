@page "/scorer/classoffering/{Id:int}/encode"
@rendermode InteractiveServer

@using System.Security.Claims
@using GradeProgressMonitoring.Models
@using GradeProgressMonitoring.Data
@using GradeProgressMonitoring.Services
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization

@attribute [Authorize(Roles = "Admin,Scorer")]

@inject ApplicationDbContext Db
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<h3>Scorer Encoding</h3>

@if (loading)
{
    <p>Loading...</p>
}
else if (offering is null)
{
    <p class="text-danger">Class offering not found.</p>
}
else
{
    <div style="margin-bottom:12px;">
        <p style="margin:0;"><b>@offering.SubjectCode</b> — @offering.SubjectTitle</p>
        <p style="margin:0;">@offering.CourseYearSection • @offering.Term / @offering.SchoolYear • <b>@offering.ClassType</b></p>

        <div style="margin-top:10px;">
            <button class="btn btn-outline-secondary" @onclick="BackToList">Back</button>
        </div>
    </div>

    <hr />

    <div>
        <label><b>Component</b></label>
        <InputSelect class="form-control"
                     TValue="int"
                     @bind-Value="selectedComponentId"
                     @bind-Value:after="OnComponentChanged">
            <option value="0">-- select --</option>
            @foreach (var c in components)
            {
                <option value="@c.GradingComponentId">@GetCompName(c)</option>
            }
        </InputSelect>
    </div>

    <div style="margin-top:10px;">
        <label><b>Item</b></label>
        <InputSelect class="form-control"
                     TValue="int"
                     @bind-Value="selectedItemId"
                     @bind-Value:after="OnItemChanged"
                     disabled="@IsItemSelectDisabled">
            <option value="0">-- select --</option>
            @foreach (var i in itemsForSelectedComponent)
            {
                <option value="@i.ComponentItemId">@i.Label</option>
            }
        </InputSelect>
    </div>

    <hr />

    @if (selectedItem is not null && enrollments.Count > 0)
    {
        <EditForm Model="grid" OnValidSubmit="SaveScoresAsync">
            <table class="table">
                <thead>
                    <tr>
                        <th>Student No</th>
                        <th>Name</th>
                        <th>Score (0..@selectedItem.MaxScore)</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in grid.Rows)
                    {
                        <tr>
                            <td>@row.StudentNo</td>
                            <td>@row.StudentName</td>
                            <td>
                                <InputNumber TValue="decimal?"
                                             class="form-control"
                                             @bind-Value="row.Score"
                                             @attributes="GetScoreInputAttributes(row)" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <button class="btn btn-primary"
                    type="submit"
                    disabled="@saving">
                @(saving ? "Saving..." : "Save Scores")
            </button>

            @if (!string.IsNullOrWhiteSpace(message))
            {
                <div class="@messageCss" style="margin-top:10px;">
                    @message
                </div>
            }
        </EditForm>
    }
}

@code {

    [Parameter] public int Id { get; set; }

    private bool loading = true;
    private bool saving = false;

    private ClassOffering? offering;
    private List<GradingComponent> components = new();
    private List<ComponentItem> itemsForSelectedComponent = new();
    private List<Enrollment> enrollments = new();

    private int selectedComponentId = 0;
    private int selectedItemId = 0;

    private GradingComponent? selectedComponent;
    private ComponentItem? selectedItem;

    private string? message;
    private string messageCss = "text-muted";

    private ScoreGridModel grid = new();

    private bool IsItemSelectDisabled =>
        selectedComponent is null || itemsForSelectedComponent.Count == 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        loading = true;

        offering = await Db.ClassOfferings
            .AsNoTracking()
            .FirstOrDefaultAsync(x => x.ClassOfferingId == Id);

        components = await Db.GradingComponents
            .AsNoTracking()
            .Where(x => x.ClassOfferingId == Id && x.IsEnabled)
            .OrderBy(x => x.ComponentType)
            .ToListAsync();

        enrollments = await Db.Enrollments
            .AsNoTracking()
            .Where(x => x.ClassOfferingId == Id)
            .OrderBy(x => x.StudentNo)
            .ToListAsync();

        loading = false;
    }

    private string GetCompName(GradingComponent c)
    {
        return GradingTemplateService.GetComponentDisplayName(c.ComponentType, offering!.ClassType);
    }

    private async Task OnComponentChanged()
    {
        selectedItemId = 0;
        selectedItem = null;
        grid = new();

        selectedComponent = components
            .FirstOrDefault(x => x.GradingComponentId == selectedComponentId);

        if (selectedComponent is null) return;

        itemsForSelectedComponent = await Db.ComponentItems
            .AsNoTracking()
            .Where(i => i.GradingComponentId == selectedComponent.GradingComponentId)
            .OrderBy(i => i.OrderNo)
            .ToListAsync();
    }

    private async Task OnItemChanged()
    {
        selectedItem = itemsForSelectedComponent
            .FirstOrDefault(x => x.ComponentItemId == selectedItemId);

        if (selectedItem is null) return;

        await LoadExistingScoresAsync();
    }

    private async Task LoadExistingScoresAsync()
    {
        var existing = await Db.ScoreEntries
            .AsNoTracking()
            .Where(s => s.ComponentItemId == selectedItem!.ComponentItemId)
            .ToListAsync();

        var byUserId = existing
            .Where(x => !string.IsNullOrWhiteSpace(x.StudentUserId))
            .GroupBy(x => x.StudentUserId)
            .ToDictionary(g => g.Key, g => g.OrderByDescending(x => x.UpdatedAt).First());

        var rows = new List<ScoreRow>();

        foreach (var e in enrollments)
        {
            var uid = (e.StudentUserId ?? "").Trim();
            decimal? score = null;

            if (!string.IsNullOrWhiteSpace(uid) &&
                byUserId.TryGetValue(uid, out var entry))
            {
                score = entry.Score;
            }

            rows.Add(new ScoreRow
            {
                StudentUserId = uid,
                StudentNo = e.StudentNo ?? "",
                StudentName = e.StudentName ?? "",
                Score = score
            });
        }

        grid = new ScoreGridModel { Rows = rows };
    }

    private async Task SaveScoresAsync()
    {
        if (selectedItem is null) return;

        saving = true;
        message = null;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var currentUserId = authState.User.FindFirstValue(ClaimTypes.NameIdentifier);

        try
        {
            var existing = await Db.ScoreEntries
                .Where(s => s.ComponentItemId == selectedItem.ComponentItemId)
                .ToListAsync();

            var byUserId = existing
                .Where(x => !string.IsNullOrWhiteSpace(x.StudentUserId))
                .GroupBy(x => x.StudentUserId)
                .ToDictionary(g => g.Key, g => g.OrderByDescending(x => x.UpdatedAt).First());

            foreach (var row in grid.Rows)
            {
                if (string.IsNullOrWhiteSpace(row.StudentUserId))
                    continue;

                if (!row.Score.HasValue)
                {
                    if (byUserId.TryGetValue(row.StudentUserId, out var removeEntry))
                        Db.ScoreEntries.Remove(removeEntry);

                    continue;
                }

                if (!byUserId.TryGetValue(row.StudentUserId, out var entry))
                {
                    Db.ScoreEntries.Add(new ScoreEntry
                    {
                        ComponentItemId = selectedItem.ComponentItemId,
                        StudentUserId = row.StudentUserId,
                        Score = row.Score,
                        EncodedByUserId = currentUserId,
                        EncodedAt = DateTime.UtcNow,   // ✅ FIXED
                        UpdatedAt = DateTime.UtcNow    // ✅ FIXED
                    });
                }
                else
                {
                    entry.Score = row.Score;
                    entry.EncodedByUserId = currentUserId;
                    entry.UpdatedAt = DateTime.UtcNow;  // ✅ FIXED
                }
            }

            await Db.SaveChangesAsync();

            message = "Scores saved successfully.";
            messageCss = "text-success";
        }
        catch (DbUpdateException ex)
        {
            message = $"Save failed: {ex.InnerException?.Message ?? ex.Message}";
            messageCss = "text-danger";
        }
        catch (Exception ex)
        {
            message = ex.ToString();
            messageCss = "text-danger";
        }
        finally
        {
            saving = false;
        }
    }

    private Dictionary<string, object> GetScoreInputAttributes(ScoreRow row)
    {
        var attrs = new Dictionary<string, object>();
        if (string.IsNullOrWhiteSpace(row.StudentUserId))
            attrs["disabled"] = "disabled";
        return attrs;
    }

    private void BackToList() =>
        Nav.NavigateTo("/scorer/classofferings");

    private class ScoreGridModel
    {
        public List<ScoreRow> Rows { get; set; } = new();
    }

    private class ScoreRow
    {
        public string StudentUserId { get; set; } = "";
        public string StudentNo { get; set; } = "";
        public string StudentName { get; set; } = "";
        public decimal? Score { get; set; }
    }
}